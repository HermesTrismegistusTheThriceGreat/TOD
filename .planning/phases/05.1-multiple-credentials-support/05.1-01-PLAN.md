---
phase: 05.1-multiple-credentials-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/orchestrator_db/migrations/15_multiple_credentials_support.sql
  - apps/orchestrator_db/models.py
autonomous: true

must_haves:
  truths:
    - "Database allows multiple credentials of same type per account (no unique constraint)"
    - "Nickname column exists and is populated for all credentials"
  artifacts:
    - path: "apps/orchestrator_db/migrations/15_multiple_credentials_support.sql"
      provides: "Database migration to drop constraint and add nickname column"
      contains: "DROP INDEX IF EXISTS idx_user_credentials_unique"
    - path: "apps/orchestrator_db/models.py"
      provides: "UserCredential Pydantic model with nickname field"
      contains: "nickname: Optional[str]"
  key_links:
    - from: "apps/orchestrator_db/migrations/15_multiple_credentials_support.sql"
      to: "user_credentials table"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "ADD COLUMN.*nickname"
---

<objective>
Create database migration and update Pydantic models to support multiple credentials per account

Purpose: Enable users to add multiple Alpaca credentials of the same type by removing the unique constraint and adding a nickname field for disambiguation
Output: Migration file that drops unique constraint, adds nickname column with backfill, and updated models.py
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-multiple-credentials-support/05.1-RESEARCH.md
@apps/orchestrator_db/migrations/14_user_accounts.sql
@apps/orchestrator_db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Migration 15 - Multiple Credentials Support</name>
  <files>apps/orchestrator_db/migrations/15_multiple_credentials_support.sql</files>
  <action>
    Create migration file with:
    1. DROP INDEX IF EXISTS idx_user_credentials_unique (removes unique constraint on user_account_id, credential_type)
    2. ALTER TABLE user_credentials ADD COLUMN IF NOT EXISTS nickname VARCHAR(255)
    3. UPDATE user_credentials SET nickname = credential_type WHERE nickname IS NULL (backfill existing rows)
    4. CREATE INDEX IF NOT EXISTS idx_user_credentials_nickname ON user_credentials(user_account_id, nickname)
    5. Add COMMENT ON COLUMN documenting nickname purpose

    Follow existing migration patterns from 14_user_accounts.sql:
    - Include header comment with description and dependencies
    - Use IF EXISTS/IF NOT EXISTS for idempotency
    - Add descriptive comments on new columns
  </action>
  <verify>
    Run: `cat apps/orchestrator_db/migrations/15_multiple_credentials_support.sql`
    - Confirms DROP INDEX statement exists
    - Confirms ADD COLUMN nickname statement exists
    - Confirms UPDATE backfill statement exists
  </verify>
  <done>
    Migration file exists with complete schema changes for multiple credentials support
  </done>
</task>

<task type="auto">
  <name>Task 2: Update UserCredential Pydantic Model</name>
  <files>apps/orchestrator_db/models.py</files>
  <action>
    Add nickname field to UserCredential class (around line 685-717):
    ```python
    nickname: Optional[str] = None  # User-friendly label for credential
    ```

    Position: Add after credential_type field, before api_key field

    Import: Ensure Optional is imported from typing (already imported on line 21)

    This follows CLAUDE.md requirement: "Keep models.py in sync with the migrations"
  </action>
  <verify>
    Run: `grep -n "nickname" apps/orchestrator_db/models.py`
    - Shows nickname field in UserCredential class
  </verify>
  <done>
    UserCredential Pydantic model includes optional nickname field
  </done>
</task>

</tasks>

<verification>
1. Migration file exists at apps/orchestrator_db/migrations/15_multiple_credentials_support.sql
2. Migration contains DROP INDEX for unique constraint
3. Migration contains ADD COLUMN for nickname
4. Migration contains UPDATE for backfill
5. models.py UserCredential class has nickname: Optional[str] field
</verification>

<success_criteria>
- Migration file is syntactically valid SQL
- models.py remains syntactically valid Python
- Pydantic model has nickname field matching database column type
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-multiple-credentials-support/05.1-01-SUMMARY.md`
</output>
