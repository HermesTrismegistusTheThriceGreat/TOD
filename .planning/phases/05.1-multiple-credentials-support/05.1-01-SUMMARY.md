---
phase: 05.1-multiple-credentials-support
plan: 01
subsystem: database
tags: [migration, pydantic, schema, multiple-credentials]

dependency-graph:
  requires: [02-01, 14_user_accounts.sql]
  provides: [nickname-column, unique-constraint-dropped]
  affects: [05.1-02, 05.1-03]

tech-stack:
  added: []
  patterns:
    - idempotent-migration
    - backfill-with-defaults

file-tracking:
  key-files:
    created:
      - apps/orchestrator_db/migrations/15_multiple_credentials_support.sql
    modified:
      - apps/orchestrator_db/models.py

decisions:
  - id: 05.1-01-01
    choice: "Use IF EXISTS/IF NOT EXISTS for idempotent migration"
    why: "Migration can be safely re-run without errors"
  - id: 05.1-01-02
    choice: "Backfill nickname with credential_type"
    why: "Existing credentials get sensible default names (alpaca_paper, alpaca_live)"
  - id: 05.1-01-03
    choice: "Add index on (user_account_id, nickname) instead of unique constraint"
    why: "Allows duplicate nicknames while maintaining query performance"

metrics:
  duration: 1.0min
  completed: 2026-01-31
---

# Phase 5.1 Plan 01: Database Schema for Multiple Credentials Summary

Database migration and Pydantic model update to support multiple credentials per account

## One-liner

Drop unique constraint on (user_account_id, credential_type), add nickname VARCHAR(255) with backfill to credential_type

## What Was Built

### Migration 15: Multiple Credentials Support

Created idempotent SQL migration that:

1. **Drops unique constraint** - `DROP INDEX IF EXISTS idx_user_credentials_unique` removes the constraint that prevented multiple credentials of the same type per account

2. **Adds nickname column** - `ALTER TABLE ADD COLUMN IF NOT EXISTS nickname VARCHAR(255)` adds user-friendly label for credential identification

3. **Backfills existing data** - `UPDATE SET nickname = credential_type WHERE nickname IS NULL` ensures existing credentials have nicknames (e.g., "alpaca_paper", "alpaca_live")

4. **Adds lookup index** - `CREATE INDEX IF NOT EXISTS idx_user_credentials_nickname` on (user_account_id, nickname) for efficient queries

### UserCredential Pydantic Model Update

Added `nickname: Optional[str] = None` field to match database schema:
- Position: after credential_type, before api_key
- Optional to support both new and migrated credentials
- Keeps models.py in sync with migrations per CLAUDE.md requirement

## Key Files

| File | Purpose |
|------|---------|
| `apps/orchestrator_db/migrations/15_multiple_credentials_support.sql` | Database migration |
| `apps/orchestrator_db/models.py` | Pydantic model with nickname field |

## Commits

| Hash | Message |
|------|---------|
| `3d34e73` | feat(05.1-01): add migration for multiple credentials support |
| `9065c03` | feat(05.1-01): add nickname field to UserCredential model |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- [x] Migration file exists at correct path
- [x] Migration contains DROP INDEX for unique constraint
- [x] Migration contains ADD COLUMN for nickname
- [x] Migration contains UPDATE for backfill
- [x] models.py UserCredential class has `nickname: Optional[str]` field
- [x] Migration SQL is syntactically valid (idempotent patterns)
- [x] Python file syntax validated via ast.parse

## Next Phase Readiness

**Ready for 05.1-02:** Backend API changes

### Prerequisites Satisfied
- Database schema supports multiple credentials per account
- Pydantic model has nickname field for API serialization
- Backfill ensures existing credentials have nicknames

### Handoff Notes
- Migration must be applied to database before API changes go live
- API should accept optional nickname on credential create
- API should return nickname in credential responses
