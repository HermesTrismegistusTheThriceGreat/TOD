---
phase: 05.1-multiple-credentials-support
plan: 02
type: execute
wave: 2
depends_on: ["05.1-01"]
files_modified:
  - apps/orchestrator_3_stream/backend/schemas/credential_schemas.py
  - apps/orchestrator_3_stream/backend/modules/credential_service.py
  - apps/orchestrator_3_stream/backend/tests/test_credential_endpoints.py
autonomous: true

must_haves:
  truths:
    - "StoreCredentialRequest accepts optional nickname field"
    - "CredentialResponse includes nickname in output"
    - "store_credential function accepts and stores nickname"
    - "Test suite no longer expects 409 Conflict on duplicate credential_type"
  artifacts:
    - path: "apps/orchestrator_3_stream/backend/schemas/credential_schemas.py"
      provides: "Request/response schemas with nickname field"
      contains: "nickname: Optional[str]"
    - path: "apps/orchestrator_3_stream/backend/modules/credential_service.py"
      provides: "Updated store_credential with nickname parameter"
      contains: "nickname: Optional[str] = None"
    - path: "apps/orchestrator_3_stream/backend/tests/test_credential_endpoints.py"
      provides: "Updated tests for multiple credentials behavior"
      contains: "test_store_multiple_credentials_same_type"
  key_links:
    - from: "credential_schemas.py"
      to: "credential_service.py"
      via: "nickname field propagation"
      pattern: "nickname"
---

<objective>
Update backend schemas, service layer, and tests to support nickname field

Purpose: Allow API to accept nickname when storing credentials and return it in responses; update tests to reflect new behavior (multiple credentials allowed)
Output: Updated schemas with nickname field, service layer storing nickname, tests updated for new behavior
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05.1-multiple-credentials-support/05.1-RESEARCH.md
@apps/orchestrator_3_stream/backend/schemas/credential_schemas.py
@apps/orchestrator_3_stream/backend/modules/credential_service.py
@apps/orchestrator_3_stream/backend/tests/test_credential_endpoints.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Nickname to Pydantic Schemas</name>
  <files>apps/orchestrator_3_stream/backend/schemas/credential_schemas.py</files>
  <action>
    1. Add nickname field to StoreCredentialRequest (after secret_key):
       ```python
       nickname: Optional[str] = Field(
           None,
           description="User-friendly label (e.g., 'Paper Account 1'). Defaults to credential_type if not provided."
       )
       ```

    2. Add nickname field to CredentialResponse (after credential_type):
       ```python
       nickname: Optional[str] = Field(None, description="User-friendly label")
       ```

    3. Optionally add nickname to UpdateCredentialRequest if users should be able to edit nicknames.

    Ensure Optional is already imported from typing (line 22).
  </action>
  <verify>
    Run: `grep -n "nickname" apps/orchestrator_3_stream/backend/schemas/credential_schemas.py`
    - Shows nickname field in StoreCredentialRequest
    - Shows nickname field in CredentialResponse
  </verify>
  <done>
    Schemas accept and return nickname field
  </done>
</task>

<task type="auto">
  <name>Task 2: Update store_credential Service Function</name>
  <files>apps/orchestrator_3_stream/backend/modules/credential_service.py</files>
  <action>
    1. Add nickname parameter to store_credential function signature (around line 200):
       ```python
       async def store_credential(
           conn,
           account_id: UUID,
           user_id: str,
           credential_type: str,
           api_key: str,
           secret_key: str,
           nickname: Optional[str] = None,  # NEW
       ) -> UUID:
       ```

    2. Add default logic after validation (around line 252):
       ```python
       # Default nickname to credential_type if not provided
       if nickname is None or nickname.strip() == "":
           nickname = credential_type
       ```

    3. Update INSERT statement to include nickname column (around line 264):
       - Add "nickname" to column list
       - Add $7 parameter for nickname value
       - Shift is_active to $8
       - Add nickname to values tuple

    4. Update logger.info to include nickname (around line 280):
       ```python
       logger.info(
           f"Credential stored: id={credential_id}, account_id={account_id}, "
           f"type={credential_type}, nickname={nickname}"
       )
       ```

    Ensure Optional is imported from typing (already on line 23).
  </action>
  <verify>
    Run: `grep -A5 "async def store_credential" apps/orchestrator_3_stream/backend/modules/credential_service.py`
    - Shows nickname parameter in function signature
  </verify>
  <done>
    store_credential function accepts and persists nickname
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Tests for Multiple Credentials Behavior</name>
  <files>apps/orchestrator_3_stream/backend/tests/test_credential_endpoints.py</files>
  <action>
    1. Rename or update test_store_credential_duplicate (around line 151):
       - Change function name to test_store_multiple_credentials_same_type
       - Change assertion: instead of expecting 409, expect 201 (success)
       - Update docstring to reflect new behavior: "Test multiple credentials of same type are allowed"

    2. Update the test to verify:
       - First credential created successfully (201)
       - Second credential with same type also created successfully (201)
       - Both credentials returned in list

    3. Optionally add a test for nickname functionality:
       ```python
       def test_store_credential_with_nickname(mock_get_conn, mock_store_cred, client, test_encryption_key, test_account_id):
           """Test storing credential with custom nickname"""
           # Mock successful store
           mock_store_cred.return_value = uuid.uuid4()
           mock_conn = AsyncMock()
           mock_get_conn.return_value.__aenter__.return_value = mock_conn

           response = client.post(
               "/credentials/store",
               json={
                   "account_id": test_account_id,
                   "credential_type": "alpaca",
                   "api_key": "PKTEST123",
                   "secret_key": "sptest123",
                   "nickname": "Paper Account 1"
               },
           )

           assert response.status_code == 201
       ```
  </action>
  <verify>
    Run: `cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/backend && uv run pytest tests/test_credential_endpoints.py -v --tb=short`
    - All tests pass
    - No test expects 409 for duplicate credential_type
  </verify>
  <done>
    Tests updated to reflect multiple credentials per type are allowed
  </done>
</task>

</tasks>

<verification>
1. Schemas have nickname field in StoreCredentialRequest and CredentialResponse
2. store_credential function has nickname parameter
3. INSERT statement includes nickname column
4. Tests pass without expecting 409 Conflict on duplicate type
5. Python syntax valid: `python -m py_compile apps/orchestrator_3_stream/backend/schemas/credential_schemas.py`
</verification>

<success_criteria>
- `uv run pytest tests/test_credential_endpoints.py -v` passes all tests
- Schemas correctly typed with Optional[str] nickname
- Service function defaults nickname to credential_type
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-multiple-credentials-support/05.1-02-SUMMARY.md`
</output>
