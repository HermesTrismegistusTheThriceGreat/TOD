---
phase: 07-data-isolation
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User switching accounts sees correct positions for each account"
    - "Different users don't see each other's data after logout/login"
    - "Empty state displayed for user with no credentials"
  artifacts: []
  key_links:
    - from: "browser test"
      to: "Open Positions page"
      via: "account switching and logout/login cycle"
---

<objective>
Verify data isolation through real browser testing with actual user accounts.

Purpose: End-to-end verification that the entire stack (frontend -> backend -> database -> RLS) correctly isolates user data. Integration tests verify code paths, but browser tests verify user experience.

Output: Verified evidence that account switching and cross-user isolation work correctly in the actual application.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-isolation/07-CONTEXT.md

# Browser automation skill
@.claude/skills/agent-browser/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify servers are running</name>
  <files></files>
  <action>
Ensure frontend and backend are running before browser tests:

1. Check if servers are running:
```bash
lsof -ti:5175 >/dev/null 2>&1 && lsof -ti:9403 >/dev/null 2>&1 && echo "Both servers running" || echo "Need to start servers"
```

2. If not running, start them:
```bash
cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream && ./start_be.sh &
sleep 3
cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream && ./start_fe.sh &
sleep 5
```

3. Verify servers respond:
```bash
curl -s http://localhost:5175 | head -c 100
curl -s http://localhost:9403/health | head -c 100
```
  </action>
  <verify>
Both servers respond to HTTP requests.
  </verify>
  <done>
Frontend (port 5175) and backend (port 9403) are running and responding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test same-user account switching</name>
  <files></files>
  <action>
Using the agent-browser skill, verify that switching between accounts updates the positions page.

Test user: seagerjoe@gmail.com / password123 (has 2 paper accounts)

1. Login as seagerjoe@gmail.com:
```bash
AGENT_BROWSER_SESSION=iso1 agent-browser open http://localhost:5175
AGENT_BROWSER_SESSION=iso1 agent-browser snapshot -i
# Find login form, fill email and password, submit
AGENT_BROWSER_SESSION=iso1 agent-browser fill @email "seagerjoe@gmail.com"
AGENT_BROWSER_SESSION=iso1 agent-browser fill @password "password123"
AGENT_BROWSER_SESSION=iso1 agent-browser click @submit
AGENT_BROWSER_SESSION=iso1 agent-browser wait --load networkidle
```

2. Navigate to Open Positions page:
```bash
AGENT_BROWSER_SESSION=iso1 agent-browser snapshot -i
# Click on Open Positions link/nav item
AGENT_BROWSER_SESSION=iso1 agent-browser click @positions-link
AGENT_BROWSER_SESSION=iso1 agent-browser wait --load networkidle
```

3. Note the current positions displayed (take screenshot or capture text):
```bash
AGENT_BROWSER_SESSION=iso1 agent-browser screenshot /tmp/account1-positions.png
AGENT_BROWSER_SESSION=iso1 agent-browser snapshot -i
```

4. Switch to second account via AccountSelector:
```bash
# Find and click account selector dropdown
AGENT_BROWSER_SESSION=iso1 agent-browser click @account-selector
AGENT_BROWSER_SESSION=iso1 agent-browser snapshot -i
# Click on second account option
AGENT_BROWSER_SESSION=iso1 agent-browser click @account-option-2
AGENT_BROWSER_SESSION=iso1 agent-browser wait --load networkidle
```

5. Verify positions page updated:
```bash
AGENT_BROWSER_SESSION=iso1 agent-browser screenshot /tmp/account2-positions.png
AGENT_BROWSER_SESSION=iso1 agent-browser snapshot -i
```

6. Close browser:
```bash
AGENT_BROWSER_SESSION=iso1 agent-browser close
```

**Success criteria:** Positions page shows different data (or different empty state) for each account.
  </action>
  <verify>
Screenshots show different content for each account, or logs show different credential_id being used.
  </verify>
  <done>
Account switching causes positions page to update with correct account's data.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Browser automation tested account switching isolation</what-built>
  <how-to-verify>
1. Review the screenshots taken at /tmp/account1-positions.png and /tmp/account2-positions.png
2. Confirm they show different data (or at minimum, different account indicator)
3. If both accounts have no positions, that's OK - verify the account selector changes

If screenshots are unclear, manually test:
1. Go to http://localhost:5175
2. Login as seagerjoe@gmail.com / password123
3. Navigate to Open Positions
4. Switch accounts using the selector
5. Verify the page updates

Note: If positions are identical, this may be correct if both paper accounts have same trades. The key is that the frontend sends the correct credential_id for each account.
  </how-to-verify>
  <resume-signal>Type "approved" if account switching works correctly, or describe the issue</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test cross-user isolation</name>
  <files></files>
  <action>
Verify that after logging out and logging in as a different user, no data from the previous user is visible.

Test users:
- seagerjoe@gmail.com / password123 (has 2 paper accounts)
- muzz@gmail.com / password123 (has no Alpaca accounts)

1. Start fresh session and login as seagerjoe:
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser open http://localhost:5175
AGENT_BROWSER_SESSION=iso2 agent-browser snapshot -i
# Login
AGENT_BROWSER_SESSION=iso2 agent-browser fill @email "seagerjoe@gmail.com"
AGENT_BROWSER_SESSION=iso2 agent-browser fill @password "password123"
AGENT_BROWSER_SESSION=iso2 agent-browser click @submit
AGENT_BROWSER_SESSION=iso2 agent-browser wait --load networkidle
```

2. Navigate to positions and note data:
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser snapshot -i
AGENT_BROWSER_SESSION=iso2 agent-browser click @positions-link
AGENT_BROWSER_SESSION=iso2 agent-browser wait --load networkidle
AGENT_BROWSER_SESSION=iso2 agent-browser screenshot /tmp/user1-positions.png
```

3. Logout:
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser snapshot -i
# Find and click logout button
AGENT_BROWSER_SESSION=iso2 agent-browser click @logout
AGENT_BROWSER_SESSION=iso2 agent-browser wait --load networkidle
```

4. Login as muzz@gmail.com:
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser snapshot -i
AGENT_BROWSER_SESSION=iso2 agent-browser fill @email "muzz@gmail.com"
AGENT_BROWSER_SESSION=iso2 agent-browser fill @password "password123"
AGENT_BROWSER_SESSION=iso2 agent-browser click @submit
AGENT_BROWSER_SESSION=iso2 agent-browser wait --load networkidle
```

5. Navigate to positions page:
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser snapshot -i
AGENT_BROWSER_SESSION=iso2 agent-browser click @positions-link
AGENT_BROWSER_SESSION=iso2 agent-browser wait --load networkidle
AGENT_BROWSER_SESSION=iso2 agent-browser screenshot /tmp/user2-positions.png
```

6. Verify empty state (muzz has no accounts):
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser snapshot -i
# Page should show "No accounts" or "Add an account" message
```

7. Close browser:
```bash
AGENT_BROWSER_SESSION=iso2 agent-browser close
```

**Success criteria:** muzz@gmail.com sees empty state or "no accounts" message, NOT seagerjoe's positions.
  </action>
  <verify>
Screenshot /tmp/user2-positions.png shows empty state or account setup prompt, not trading data.
  </verify>
  <done>
Cross-user isolation verified - different user sees only their own data (or empty state if no accounts).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Browser automation verified cross-user data isolation</what-built>
  <how-to-verify>
1. Review /tmp/user1-positions.png (seagerjoe's data)
2. Review /tmp/user2-positions.png (muzz's data - should be empty/different)
3. Confirm no data from seagerjoe appears after login as muzz

If screenshots are unclear, manually test:
1. Login as seagerjoe@gmail.com, view positions
2. Logout
3. Login as muzz@gmail.com, view positions
4. Confirm muzz sees no positions or "add account" prompt (not seagerjoe's data)
  </how-to-verify>
  <resume-signal>Type "approved" if cross-user isolation works, or describe the issue</resume-signal>
</task>

</tasks>

<verification>
1. Account switching test: Screenshots show different data for each account
2. Cross-user test: Second user sees empty state, not first user's data
3. No data leakage observed between users or accounts
</verification>

<success_criteria>
- [ ] seagerjoe can switch between 2 accounts and see different data for each
- [ ] muzz sees empty state (no accounts) after logging out of seagerjoe's session
- [ ] No positions/orders from seagerjoe visible when logged in as muzz
- [ ] Account selector correctly triggers data refresh
- [ ] Human verification confirms isolation works
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-isolation/07-03-SUMMARY.md`
</output>
