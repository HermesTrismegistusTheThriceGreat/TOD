---
phase: 07-data-isolation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/orchestrator_3_stream/backend/main.py
  - apps/orchestrator_3_stream/backend/modules/database.py
autonomous: true

must_haves:
  truths:
    - "Credential access denials are logged with structured JSON format"
    - "Logs include user_id, credential_id, action, and reason"
    - "Suspicious access attempts are observable in application logs"
  artifacts:
    - path: "apps/orchestrator_3_stream/backend/main.py"
      provides: "Enhanced logging in positions/orders endpoints"
      contains: "suspicious_access"
    - path: "apps/orchestrator_3_stream/backend/modules/database.py"
      provides: "Optional logging function for RLS context failures"
  key_links:
    - from: "apps/orchestrator_3_stream/backend/main.py"
      to: "logger"
      via: "structured JSON log on credential access denial"
      pattern: "logger\\.(warning|error).*credential.*denied"
---

<objective>
Add structured logging for suspicious access attempts across credential-protected endpoints.

Purpose: Enable observability of data isolation - when a user attempts to access a credential they don't own, this is logged with full context for debugging and audit.

Output: Enhanced logging in positions and orders endpoints that captures credential access denials with structured JSON format.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-isolation/07-CONTEXT.md
@.planning/phases/07-data-isolation/07-RESEARCH.md

# Existing endpoints that need logging enhancement
@apps/orchestrator_3_stream/backend/main.py
@apps/orchestrator_3_stream/backend/modules/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structured logging for credential access denials</name>
  <files>apps/orchestrator_3_stream/backend/main.py</files>
  <action>
Enhance the credential access denial handling in the following endpoints:

1. **GET /api/positions** (line ~1243):
   - In the `except ValueError` block, add structured logging before returning error
   - Log format: `logger.warning("SUSPICIOUS_ACCESS", extra={"user_id": user_id, "credential_id": credential_id, "action": "get_positions", "reason": str(e)})`
   - Keep existing error return behavior

2. **GET /api/orders** (line ~1354):
   - Same pattern: structured log in the `except ValueError` block
   - Log with action="get_orders"

3. **POST /api/alpaca-agent/chat** (find the chat endpoint):
   - If it has credential validation, add same logging pattern
   - Log with action="chat"

Use the existing `logger` import - do not create a new logger.

The log format should be JSON-serializable via the existing logging config. Include:
- `user_id`: The authenticated user attempting access
- `credential_id`: The credential they tried to access
- `action`: Which endpoint was called
- `reason`: The error message (e.g., "Credential not found")

Do NOT log any credential values (api_key, secret_key) - only metadata.
  </action>
  <verify>
Run the backend with `uv run python main.py` and verify:
1. No import errors
2. No syntax errors
3. Logging statements compile correctly
  </verify>
  <done>
Positions, orders, and chat endpoints log credential access denials with structured format including user_id, credential_id, action, and reason.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helper function for suspicious access logging</name>
  <files>apps/orchestrator_3_stream/backend/modules/database.py</files>
  <action>
Add a reusable helper function for logging suspicious access attempts. This centralizes the log format.

Add at the end of database.py (before any if __name__ block):

```python
def log_suspicious_access(
    user_id: str,
    credential_id: str,
    action: str,
    reason: str
) -> None:
    """
    Log a suspicious access attempt with structured format.

    Called when a user attempts to access a credential they don't own,
    or when RLS policies prevent access.

    Args:
        user_id: The authenticated user attempting access
        credential_id: The credential ID they tried to access
        action: The action attempted (e.g., "get_positions", "chat")
        reason: Why access was denied
    """
    from .log_service import get_logger
    logger = get_logger()
    logger.warning(
        f"SUSPICIOUS_ACCESS: {action}",
        extra={
            "event_type": "suspicious_access",
            "user_id": user_id,
            "credential_id": credential_id,
            "action": action,
            "reason": reason
        }
    )
```

Then update main.py to use this helper in the exception handlers instead of inline logging.

Import at top of main.py:
```python
from modules.database import log_suspicious_access
```

Update exception handlers to call:
```python
log_suspicious_access(user_id, credential_id, "get_positions", str(e))
```
  </action>
  <verify>
1. `uv run python -c "from modules.database import log_suspicious_access; print('OK')"`
2. Verify main.py still starts without errors
  </verify>
  <done>
log_suspicious_access helper function exists and is used by credential-protected endpoints.
  </done>
</task>

</tasks>

<verification>
1. Backend starts without errors: `cd apps/orchestrator_3_stream/backend && uv run python main.py`
2. Import check: `uv run python -c "from modules.database import log_suspicious_access"`
3. No credential values in log format (security check)
</verification>

<success_criteria>
- [ ] log_suspicious_access function exists in database.py
- [ ] GET /api/positions logs denials with structured format
- [ ] GET /api/orders logs denials with structured format
- [ ] Chat endpoint logs denials if it validates credentials
- [ ] No credential secrets appear in log messages
- [ ] Backend starts and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-isolation/07-01-SUMMARY.md`
</output>
