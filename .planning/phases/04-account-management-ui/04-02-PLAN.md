---
phase: 04-account-management-ui
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/orchestrator_3_stream/frontend/src/types/account.ts
  - apps/orchestrator_3_stream/frontend/src/services/credentialService.ts
  - apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match backend CredentialResponse and UserAccountResponse"
    - "credentialService provides all CRUD methods for credentials API"
    - "accountStore tracks credentials, activeCredentialId, and userAccount"
    - "Store handles loading, error, and optimistic updates"
  artifacts:
    - path: "apps/orchestrator_3_stream/frontend/src/types/account.ts"
      provides: "TypeScript interfaces for account and credential types"
      exports: ["CredentialResponse", "UserAccountResponse", "CredentialInput", "CredentialUpdate"]
    - path: "apps/orchestrator_3_stream/frontend/src/services/credentialService.ts"
      provides: "HTTP service for credential and account API calls"
      exports: ["credentialService"]
    - path: "apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts"
      provides: "Pinia store for account and credential state management"
      exports: ["useAccountStore"]
  key_links:
    - from: "apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts"
      to: "apps/orchestrator_3_stream/frontend/src/services/credentialService.ts"
      via: "import credentialService"
      pattern: "import.*credentialService"
    - from: "apps/orchestrator_3_stream/frontend/src/services/credentialService.ts"
      to: "apps/orchestrator_3_stream/frontend/src/services/api.ts"
      via: "apiClient import"
      pattern: "import.*apiClient.*from.*api"
---

<objective>
Create frontend service layer: TypeScript types, HTTP service, and Pinia store.

Purpose: Establish the data layer for credential management UI. Types define contracts with backend. Service handles HTTP. Store manages reactive state.

Output:
- account.ts with TypeScript interfaces matching backend schemas
- credentialService.ts with all CRUD methods
- accountStore.ts Pinia store with state, getters, and actions
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/orchestrator_3_stream/backend/schemas/credential_schemas.py
@apps/orchestrator_3_stream/frontend/src/services/api.ts
@apps/orchestrator_3_stream/frontend/src/services/alpacaService.ts
@apps/orchestrator_3_stream/frontend/src/stores/orchestratorStore.ts
@.planning/phases/04-account-management-ui/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types for accounts and credentials</name>
  <files>apps/orchestrator_3_stream/frontend/src/types/account.ts</files>
  <action>
Create TypeScript interfaces that mirror backend Pydantic schemas:

1. CredentialResponse - Mirrors backend CredentialResponse
   - id: string
   - account_id: string
   - credential_type: string
   - is_active: boolean
   - created_at: string
   - updated_at: string

2. ListCredentialsResponse - Mirrors backend ListCredentialsResponse
   - status: string
   - credentials: CredentialResponse[]
   - count: number

3. ValidateCredentialResponse - Mirrors backend ValidateCredentialResponse
   - is_valid: boolean
   - message: string
   - account_type: string | null

4. CredentialInput - For add credential form
   - credential_type: string
   - api_key: string
   - secret_key: string

5. CredentialUpdate - For update credential form
   - api_key?: string
   - secret_key?: string
   - is_active?: boolean

6. UserAccountResponse - Mirrors backend UserAccountResponse
   - id: string
   - user_id: string
   - account_name: string
   - is_active: boolean
   - created_at: string
   - updated_at: string

7. ListAccountsResponse - Mirrors backend ListAccountsResponse
   - status: string
   - accounts: UserAccountResponse[]
   - count: number

8. GetOrCreateAccountResponse - Mirrors backend GetOrCreateAccountResponse
   - account: UserAccountResponse
   - created: boolean

Add JSDoc comments to each interface describing its purpose.
  </action>
  <verify>uv run npm run type-check (or tsc --noEmit) from frontend directory passes without errors</verify>
  <done>account.ts exists with all 8 TypeScript interfaces matching backend schemas</done>
</task>

<task type="auto">
  <name>Task 2: Create credential service with HTTP methods</name>
  <files>apps/orchestrator_3_stream/frontend/src/services/credentialService.ts</files>
  <action>
Create service module following alpacaService.ts pattern:

1. Import apiClient from './api'
2. Import types from '@/types/account'

3. Create credentialService object with methods:

a) getOrCreateAccount(): Promise<GetOrCreateAccountResponse>
   - POST /api/accounts/get-or-create
   - Returns user's account (creates if none exists)

b) listAccounts(): Promise<UserAccountResponse[]>
   - GET /api/accounts
   - Returns response.data.accounts

c) listCredentials(accountId: string): Promise<CredentialResponse[]>
   - GET /api/credentials with params: { account_id: accountId }
   - Returns response.data.credentials

d) storeCredential(data: { account_id: string; credential_type: string; api_key: string; secret_key: string }): Promise<CredentialResponse>
   - POST /api/credentials/store
   - Returns response.data

e) updateCredential(credentialId: string, data: CredentialUpdate): Promise<CredentialResponse>
   - PUT /api/credentials/{credentialId}
   - Returns response.data

f) deleteCredential(credentialId: string): Promise<void>
   - DELETE /api/credentials/{credentialId}
   - No return value (204 No Content)

g) validateCredential(credentialId: string): Promise<ValidateCredentialResponse>
   - POST /api/credentials/{credentialId}/validate
   - Returns response.data

All methods should use async/await and let axios error interceptors handle errors.
Export the service as default and named export.
  </action>
  <verify>uv run npm run type-check from frontend directory - service compiles without type errors</verify>
  <done>credentialService.ts exists with 7 methods matching backend API contract</done>
</task>

<task type="auto">
  <name>Task 3: Create Pinia account store</name>
  <files>apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts</files>
  <action>
Create Pinia store following orchestratorStore.ts composition API pattern:

1. Import: defineStore from 'pinia', ref, computed from 'vue'
2. Import types from '@/types/account'
3. Import credentialService from '@/services/credentialService'

4. Define useAccountStore with composition API:

STATE (ref):
- userAccount: ref<UserAccountResponse | null>(null) - Current user's account
- credentials: ref<CredentialResponse[]>([]) - List of credentials
- activeCredentialId: ref<string | null>(null) - Selected credential for trading
- isLoading: ref<boolean>(false) - Loading indicator
- error: ref<string | null>(null) - Error message

GETTERS (computed):
- activeCredential: computed - Returns credential object matching activeCredentialId
- hasCredentials: computed - Boolean if credentials.length > 0
- alpacaCredentials: computed - Filter credentials where credential_type === 'alpaca'

STATE (ref) - additional:
- isInitialized: ref<boolean>(false) - Prevents duplicate initialization

ACTIONS (async functions):
- initialize(): Promise<void>
  - GUARD: If isInitialized is true, return early (prevent duplicate calls)
  - Set isInitialized = true at start
  - Call getOrCreateAccount to get user's account
  - Set userAccount
  - Call fetchCredentials with account.id
  - Auto-select first active credential
  - On error: Set isInitialized = false (allow retry)

- reset(): void
  - Clear all state (userAccount, credentials, activeCredentialId, error)
  - Set isInitialized = false
  - Use this when user logs out

- fetchCredentials(accountId?: string): Promise<void>
  - Use accountId param or userAccount.id
  - Call listCredentials
  - Set credentials array
  - Auto-select first active if none selected

- addCredential(input: CredentialInput): Promise<CredentialResponse>
  - Set isLoading = true
  - Call storeCredential with userAccount.id
  - Push result to credentials array
  - Return the new credential

- updateCredential(credentialId: string, data: CredentialUpdate): Promise<CredentialResponse>
  - Set isLoading = true
  - Call updateCredential
  - Update credential in array
  - Return updated credential

- removeCredential(credentialId: string): Promise<void>
  - Set isLoading = true
  - Call deleteCredential
  - Filter out from credentials array
  - Clear activeCredentialId if it was deleted

- setActiveCredential(credentialId: string): void
  - Set activeCredentialId
  - Persist to localStorage: 'activeCredentialId'

- loadActiveCredential(): void
  - Load from localStorage: 'activeCredentialId'
  - Validate it exists in credentials array

All actions should:
- Set error = null at start
- Set isLoading = false in finally block
- Catch errors, set error message, then re-throw for component handling

Return public API at end.
  </action>
  <verify>uv run npm run type-check from frontend directory - store compiles without type errors</verify>
  <done>accountStore.ts exists with state, getters, and all CRUD actions using credentialService</done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors: npm run type-check
2. Types match backend schema field names and types exactly
3. credentialService methods call correct endpoints with correct HTTP verbs
4. accountStore actions properly manage loading/error state
5. Store persists activeCredentialId to localStorage
</verification>

<success_criteria>
- account.ts has 8 TypeScript interfaces
- credentialService.ts has 7 HTTP methods
- accountStore.ts has composition API store with 8 actions (including initialize guard and reset)
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-account-management-ui/04-02-SUMMARY.md`
</output>
