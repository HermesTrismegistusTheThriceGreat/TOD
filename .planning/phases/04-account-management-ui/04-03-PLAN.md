---
phase: 04-account-management-ui
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/orchestrator_3_stream/frontend/src/components/AccountManagerDialog.vue
  - apps/orchestrator_3_stream/frontend/src/components/AccountListView.vue
  - apps/orchestrator_3_stream/frontend/src/components/AccountSelector.vue
  - apps/orchestrator_3_stream/frontend/src/components/AppHeader.vue
  - apps/orchestrator_3_stream/frontend/src/router/index.ts
autonomous: false

must_haves:
  truths:
    - "User can add a new Alpaca account by entering API key + secret"
    - "User can view a list of all their connected accounts"
    - "User can switch active account via dropdown selector"
    - "User can update credentials for an existing account"
    - "User can remove a connected account"
  artifacts:
    - path: "apps/orchestrator_3_stream/frontend/src/components/AccountManagerDialog.vue"
      provides: "Modal dialog for adding/editing credentials"
      min_lines: 100
    - path: "apps/orchestrator_3_stream/frontend/src/components/AccountListView.vue"
      provides: "Table view of user's credentials with actions"
      min_lines: 80
    - path: "apps/orchestrator_3_stream/frontend/src/components/AccountSelector.vue"
      provides: "Dropdown selector for switching active credential"
      min_lines: 50
    - path: "apps/orchestrator_3_stream/frontend/src/components/AppHeader.vue"
      provides: "Header with integrated account selector"
      contains: "AccountSelector"
  key_links:
    - from: "apps/orchestrator_3_stream/frontend/src/components/AccountManagerDialog.vue"
      to: "apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts"
      via: "useAccountStore import"
      pattern: "import.*useAccountStore"
    - from: "apps/orchestrator_3_stream/frontend/src/components/AppHeader.vue"
      to: "apps/orchestrator_3_stream/frontend/src/components/AccountSelector.vue"
      via: "component import"
      pattern: "import AccountSelector"
    - from: "apps/orchestrator_3_stream/frontend/src/router/index.ts"
      to: "apps/orchestrator_3_stream/frontend/src/components/AccountListView.vue"
      via: "lazy import"
      pattern: "import.*AccountListView"
---

<objective>
Create frontend UI components for account management.

Purpose: Provide user-facing interface for ACCT-01 through ACCT-05 requirements: add, view, switch, update, and remove Alpaca accounts.

Output:
- AccountManagerDialog.vue for add/edit credential modal
- AccountListView.vue for viewing credentials with action buttons
- AccountSelector.vue for switching active account
- AppHeader.vue updated with account selector integration
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts
@apps/orchestrator_3_stream/frontend/src/components/AppHeader.vue
@.planning/phases/04-account-management-ui/04-RESEARCH.md
@.planning/phases/04-account-management-ui/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccountManagerDialog component</name>
  <files>apps/orchestrator_3_stream/frontend/src/components/AccountManagerDialog.vue</files>
  <action>
Create Vue 3 component for add/edit credential modal using Element Plus:

TEMPLATE:
1. el-dialog with v-model for visibility
   - title: "Add New Account" or "Edit Account" based on mode
   - width: "500px"
   - @close handler to reset form

2. el-form inside dialog
   - ref="formRef" for validation
   - :model="formData"
   - :rules="validationRules"
   - label-width="120px"

3. Form fields:
   - el-form-item label="Account Type" prop="credential_type"
     - el-select with option "Alpaca Trading" value="alpaca"
   - el-form-item label="API Key" prop="api_key"
     - el-input v-model type="password" placeholder="PK..." show-password
   - el-form-item label="Secret Key" prop="secret_key"
     - el-input v-model type="password" placeholder="sp..." show-password

4. Dialog footer with #footer slot:
   - el-button @click="handleClose" - Cancel
   - el-button type="primary" :loading="store.isLoading" @click="handleSubmit"
     - Text: "Update" or "Add" based on mode

SCRIPT SETUP:
1. Props:
   - visible: boolean (v-model)
   - credentialId?: string (if provided, edit mode)

2. Emits:
   - update:visible
   - success

3. Use:
   - useAccountStore()
   - ref for formRef, formData
   - reactive for validationRules

4. validationRules object:
   - api_key: [{ required: true, message: 'API key is required', trigger: 'blur' }]
   - secret_key: [{ required: true, message: 'Secret key is required', trigger: 'blur' }]
   - credential_type: [{ required: true, message: 'Account type is required', trigger: 'change' }]

5. handleClose: reset form, emit update:visible false

6. handleSubmit:
   - await formRef.validate()
   - if edit mode: await store.updateCredential()
   - if add mode: await store.addCredential()
   - ElMessage.success()
   - emit success
   - handleClose()
   - catch: ElMessage.error()

IMPORTANT: Use type="password" on all credential inputs to prevent exposure.
Never console.log credential values.

ERROR STATE HANDLING:
- Display store.error in an el-alert component below the form when not null
- Show el-alert type="error" with store.error message
- Clear error on dialog open/close

STYLE: scoped, follow existing component styles
- Apply dark theme overrides to el-dialog, el-form, el-input, el-select
- Use CSS variables: var(--bg-secondary), var(--bg-tertiary), var(--border-color), var(--text-primary)
- Match existing TradeStats.vue dialog/form styling patterns
  </action>
  <verify>Component renders in browser without errors when imported</verify>
  <done>AccountManagerDialog.vue exists with form validation, add/edit modes, password-masked inputs</done>
</task>

<task type="auto">
  <name>Task 2: Create AccountListView component</name>
  <files>apps/orchestrator_3_stream/frontend/src/components/AccountListView.vue</files>
  <action>
Create Vue 3 component for displaying credentials list with actions:

TEMPLATE:
1. Container div with class "account-list-view"

2. Header section:
   - Title "Connected Accounts"
   - el-button type="primary" @click="showAddDialog" - "Add Account"

3. el-table :data="store.credentials" :loading="store.isLoading"
   - el-table-column prop="credential_type" label="Type" width="120"
     - Use template slot to capitalize/format type
   - el-table-column label="Status" width="100"
     - el-tag :type="scope.row.is_active ? 'success' : 'info'" - Active/Inactive
   - el-table-column prop="created_at" label="Added" width="150"
     - Format date nicely
   - el-table-column label="Actions" width="200"
     - el-button size="small" @click="handleEdit(scope.row)" - Edit
     - el-button size="small" @click="handleValidate(scope.row)" - Test
     - el-button size="small" type="danger" @click="handleDelete(scope.row)" - Remove

4. Empty state when no credentials:
   - el-empty description="No accounts connected yet"

5. AccountManagerDialog component
   - v-model:visible="dialogVisible"
   - :credentialId="editingCredentialId"
   - @success="handleDialogSuccess"

SCRIPT SETUP:
1. Import useAccountStore, AccountManagerDialog, ElMessage, ElMessageBox

2. State:
   - dialogVisible ref
   - editingCredentialId ref (null for add, string for edit)

3. showAddDialog(): set editingCredentialId = null, dialogVisible = true

4. handleEdit(credential): set editingCredentialId = credential.id, dialogVisible = true

5. handleValidate(credential):
   - const result = await credentialService.validateCredential(credential.id)
   - if result.is_valid: ElMessage.success with account_type
   - else: ElMessage.warning("Invalid credentials")

6. handleDelete(credential):
   - await ElMessageBox.confirm("Are you sure...", "Delete Account", { type: 'warning' })
   - await store.removeCredential(credential.id)
   - ElMessage.success("Account removed")
   - catch (cancel): do nothing

7. handleDialogSuccess(): refresh list if needed

8. onMounted: store.initialize() if not already loaded

ERROR STATE HANDLING:
- Display store.error prominently above the table when not null
- Use el-alert type="error" :closable="false" to show errors
- Provide a "Retry" button that calls store.fetchCredentials()

STYLE: scoped, card-like appearance, proper spacing
- Apply dark theme overrides to el-table, el-tag, el-button, el-empty
- Use CSS variables from global.css: var(--bg-secondary), var(--bg-tertiary), var(--border-color)
- Style el-table header and cells like TradeStats.vue:
  :header-cell-style="{ background: 'var(--bg-tertiary)', borderBottom: '1px solid var(--border-color)' }"
  :cell-style="{ background: 'var(--bg-secondary)', borderBottom: '1px solid var(--border-light)' }"
  </action>
  <verify>Component renders table with action buttons when imported</verify>
  <done>AccountListView.vue exists with table, CRUD actions, delete confirmation, and embedded dialog</done>
</task>

<task type="auto">
  <name>Task 3: Create AccountSelector dropdown component</name>
  <files>apps/orchestrator_3_stream/frontend/src/components/AccountSelector.vue</files>
  <action>
Create compact dropdown component for switching active account:

TEMPLATE:
1. Container div class="account-selector"

2. el-select
   - v-model="selectedId"
   - :loading="store.isLoading"
   - placeholder="Select account"
   - size="small"
   - @change="handleChange"

3. el-option for each credential:
   - v-for="cred in store.alpacaCredentials"
   - :key="cred.id"
   - :label="formatLabel(cred)"
   - :value="cred.id"

4. If no credentials:
   - Show placeholder text or link to add account

SCRIPT SETUP:
1. Import useAccountStore, computed

2. Use: const store = useAccountStore()

3. selectedId computed with getter/setter:
   - get: return store.activeCredentialId || ''
   - set: store.setActiveCredential(value)

4. formatLabel(cred):
   - Return something like "Alpaca - {date added}" or just credential_type capitalized
   - Keep it short for header display

5. handleChange():
   - Optional: emit event for parent if needed
   - Store handles persistence automatically

6. onMounted:
   - store.loadActiveCredential() to restore from localStorage

STYLE:
- Compact for header placement
- Match existing header button styles (dark theme)
- Max width around 200px
- Apply dark theme overrides to el-select:
  - Background: var(--bg-tertiary)
  - Border: 1px solid var(--border-color)
  - Text color: var(--text-secondary)
  - On hover: border-color var(--accent-primary)
- Style dropdown menu with var(--bg-secondary) background
  </action>
  <verify>Component renders dropdown in header position without breaking layout</verify>
  <done>AccountSelector.vue exists with el-select bound to store.activeCredentialId</done>
</task>

<task type="auto">
  <name>Task 4: Integrate AccountSelector into AppHeader</name>
  <files>apps/orchestrator_3_stream/frontend/src/components/AppHeader.vue</files>
  <action>
Add AccountSelector to the AppHeader component:

1. Add import at top of script:
   import AccountSelector from './AccountSelector.vue'
   import { useAccountStore } from '../stores/accountStore'

2. In script setup, add:
   const accountStore = useAccountStore()

3. AUTH-GUARDED INITIALIZATION (fixes race condition):
   - Do NOT call initialize() in onMounted unconditionally
   - Instead, use a watcher on authStore.isAuthenticated:

   ```typescript
   // Initialize account store only when authenticated
   watch(
     () => authStore.isAuthenticated,
     async (isAuth) => {
       if (isAuth) {
         await accountStore.initialize()
       } else {
         // User logged out - reset store
         accountStore.reset()
       }
     },
     { immediate: true }
   )
   ```

4. In template, add AccountSelector to DESKTOP navigation:
   - Place it in .header-actions div, BEFORE the navigation buttons
   - Wrap in v-if="authStore.isAuthenticated" to only show when logged in

   Example placement:
   <div class="header-actions">
     <AccountSelector v-if="authStore.isAuthenticated" class="desktop-nav" />
     <!-- existing nav buttons -->
   </div>

5. MOBILE MENU INTEGRATION:
   - Add AccountSelector to the mobile-dropdown menu as well
   - Place it at the top of the mobile menu items
   - Use a different styling for mobile (full width)

   ```vue
   <div v-if="mobileMenuOpen" class="mobile-dropdown">
     <div v-if="authStore.isAuthenticated" class="mobile-account-selector">
       <AccountSelector />
     </div>
     <!-- existing mobile menu items -->
   </div>
   ```

6. Add CSS for account selector positioning:
   - Desktop: Add margin-right, separator border
   - Mobile: Full width, different padding

   ```css
   .header-actions .account-selector {
     margin-right: var(--spacing-md);
     padding-right: var(--spacing-md);
     border-right: 1px solid var(--border-color);
   }

   .mobile-account-selector {
     padding: var(--spacing-sm) var(--spacing-md);
     border-bottom: 1px solid var(--border-color);
   }

   .mobile-account-selector .account-selector {
     width: 100%;
   }

   /* Hide desktop selector on mobile */
   @media (max-width: 768px) {
     .header-actions > .account-selector.desktop-nav {
       display: none;
     }
   }
   ```

The AccountSelector should appear to the left of ALPACA, POSITIONS, etc buttons on desktop.
On mobile, it appears at the top of the hamburger dropdown menu.
Only visible when user is authenticated.
  </action>
  <verify>Header shows account selector dropdown when logged in (desktop and mobile), not visible when logged out</verify>
  <done>AppHeader.vue imports and renders AccountSelector with auth-guarded initialization and mobile support</done>
</task>

<task type="auto">
  <name>Task 5: Add /accounts route for AccountListView</name>
  <files>apps/orchestrator_3_stream/frontend/src/router/index.ts</files>
  <action>
Add a dedicated route for the account management page:

1. Import AccountListView component:
   ```typescript
   const AccountListView = () => import('../components/AccountListView.vue')
   ```

2. Add route to routes array:
   ```typescript
   {
     path: '/accounts',
     name: 'Accounts',
     component: AccountListView,
     meta: { requiresAuth: true }
   }
   ```

3. Place the route after the /alpaca-agent route for organizational consistency.

4. The meta.requiresAuth ensures the route is protected by the auth guard.

5. OPTIONAL: Add a navigation button to AppHeader for accessing /accounts:
   - Add a "MANAGE" or gear icon button next to AccountSelector
   - Or add "Manage Accounts" option in the mobile menu
   - This can be a simple router-link or button with router.push('/accounts')

   Example in AppHeader.vue template:
   ```vue
   <button
     v-if="authStore.isAuthenticated"
     class="btn-prompt desktop-nav"
     :class="{ active: route.path === '/accounts' }"
     @click="router.push('/accounts')"
     title="Manage Accounts"
   >
     <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <circle cx="12" cy="12" r="3" />
       <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
     </svg>
     ACCOUNTS
   </button>
   ```

   And in mobile menu:
   ```vue
   <button
     class="mobile-menu-item"
     :class="{ active: route.path === '/accounts' }"
     @click="handleMobileNav('/accounts')"
   >
     MANAGE ACCOUNTS
   </button>
   ```
  </action>
  <verify>Navigate to http://localhost:5175/accounts and see AccountListView rendered. Verify auth guard redirects to login if not authenticated.</verify>
  <done>Route /accounts exists with AccountListView component and navigation buttons in header (desktop + mobile)</done>
</task>

<task type="auto">
  <name>Task 6: Automated UI validation with agent-browser</name>
  <files></files>
  <action>
Invoke the agent-browser skill to validate all account management UI flows.

**Pre-requisites:**
- Backend running on port 9403: `cd apps/orchestrator_3_stream && ./start_be.sh`
- Frontend running on port 5175: `cd apps/orchestrator_3_stream && ./start_fe.sh`
- Test credentials from root `.env` file (TEST_USER_EMAIL, TEST_USER_PASSWORD)

**Validation Flows to Execute:**

1. **Auth Guard Test**
   ```bash
   agent-browser open http://localhost:5175/accounts
   agent-browser get url
   # Verify: URL contains "/login" (redirected because not authenticated)
   agent-browser screenshot ./validation/01-auth-guard-redirect.png
   ```

2. **Login Flow**
   ```bash
   agent-browser snapshot -i
   # Find email/password inputs and login button
   agent-browser fill @emailInput "$TEST_USER_EMAIL"
   agent-browser fill @passwordInput "$TEST_USER_PASSWORD"
   agent-browser click @loginBtn
   agent-browser wait --url "**/alpaca-agent" 10000
   agent-browser screenshot ./validation/02-logged-in.png
   ```

3. **Header AccountSelector Visible**
   ```bash
   agent-browser snapshot -i
   # Verify: AccountSelector component visible in header (.account-selector or el-select)
   agent-browser screenshot ./validation/03-header-selector.png
   ```

4. **Navigate to /accounts**
   ```bash
   agent-browser open http://localhost:5175/accounts
   agent-browser wait --load networkidle
   agent-browser snapshot -i
   # Verify: "Connected Accounts" title visible
   # Verify: "Add Account" button visible
   agent-browser screenshot ./validation/04-account-list-view.png
   ```

5. **Add Account Dialog Opens**
   ```bash
   agent-browser click @addAccountBtn
   agent-browser wait 1000
   agent-browser snapshot -i
   # Verify: Dialog visible with title "Add New Account"
   # Verify: Form fields: credential_type (select), api_key (password), secret_key (password)
   agent-browser screenshot ./validation/05-add-dialog.png
   ```

6. **Form Validation Errors**
   ```bash
   # Submit empty form to trigger validation
   agent-browser click @submitBtn
   agent-browser wait 500
   agent-browser snapshot -i
   # Verify: Validation error messages appear for required fields
   agent-browser screenshot ./validation/06-validation-errors.png
   ```

7. **Close Dialog**
   ```bash
   agent-browser click @cancelBtn
   agent-browser wait 500
   agent-browser snapshot -i
   # Verify: Dialog closed, back to list view
   ```

8. **Account Selector Dropdown**
   ```bash
   # Return to main page to test selector
   agent-browser open http://localhost:5175/alpaca-agent
   agent-browser wait --load networkidle
   agent-browser snapshot -i
   # Click account selector dropdown
   agent-browser click @accountSelector
   agent-browser wait 500
   agent-browser snapshot -i
   agent-browser screenshot ./validation/07-selector-dropdown.png
   ```

9. **Mobile Responsive View**
   ```bash
   agent-browser set viewport 375 812
   agent-browser reload
   agent-browser wait --load networkidle
   agent-browser snapshot -i
   # Verify: Mobile hamburger menu visible
   # Click hamburger to open mobile menu
   agent-browser click @mobileMenuBtn
   agent-browser wait 500
   agent-browser snapshot -i
   # Verify: AccountSelector visible in mobile menu
   agent-browser screenshot ./validation/08-mobile-menu.png
   ```

10. **Reset and Cleanup**
    ```bash
    agent-browser set viewport 1920 1080
    agent-browser close
    ```

**Output:**
Create validation report with pass/fail for each flow. All screenshots saved to `./validation/` directory.
  </action>
  <verify>All 9 validation flows execute successfully. Screenshots captured for visual verification.</verify>
  <done>agent-browser automated validation complete - all UI flows verified with screenshots</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 7: Human UX Verification</name>
  <what-built>Complete account management UI with add/edit dialog, list view, header selector, and dedicated /accounts route</what-built>
  <how-to-verify>
    1. Start backend: cd apps/orchestrator_3_stream && ./start_be.sh
    2. Start frontend: cd apps/orchestrator_3_stream && ./start_fe.sh
    3. Verify: When NOT logged in, navigating to /accounts redirects to /login
    4. Log in with existing user credentials
    5. Verify: Account selector appears in header on desktop (may show "Select account" initially)
    6. Verify: On mobile (resize window or use dev tools), account selector appears in hamburger menu
    7. Click "ACCOUNTS" button in header (or navigate to /accounts directly)
    8. Verify: AccountListView page renders with "Connected Accounts" title
    9. Click "Add Account" button
    10. Enter test Alpaca API key and secret (use paper trading credentials if available)
    11. Submit the form - verify success message appears
    12. Verify: New account appears in list with Edit/Test/Remove buttons
    13. Click "Test" button - verify validation result message
    14. Verify: Account selector in header now shows the added account
    15. Select the account from dropdown - verify it becomes active
    16. Refresh page - verify active account persists (localStorage)
    17. Click "Edit" on the account - verify dialog opens in edit mode
    18. Click "Remove" on the account - verify confirmation dialog appears
    19. Confirm delete - verify account is removed from list
    20. Log out - verify account selector disappears and store is reset
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. AccountManagerDialog renders with form validation
2. AccountListView shows credentials table with actions
3. AccountSelector shows in header when authenticated
4. Add flow: form -> submit -> credential appears in list and selector
5. Edit flow: click edit -> dialog prefilled -> submit -> updates
6. Delete flow: click remove -> confirm -> credential removed
7. Switch flow: select different account -> activeCredentialId updates
8. Persistence: refresh page -> active account restored from localStorage
</verification>

<success_criteria>
All Phase 4 requirements satisfied:
- ACCT-01: User can add new Alpaca account (Add Account button + dialog)
- ACCT-02: User can view list of connected accounts (AccountListView table)
- ACCT-03: User can switch active account (AccountSelector dropdown)
- ACCT-04: User can update credentials (Edit button + dialog)
- ACCT-05: User can remove connected account (Remove button + confirmation)
</success_criteria>

<output>
After completion, create `.planning/phases/04-account-management-ui/04-03-SUMMARY.md`
</output>
