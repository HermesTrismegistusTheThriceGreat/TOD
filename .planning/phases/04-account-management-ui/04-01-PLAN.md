---
phase: 04-account-management-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/orchestrator_3_stream/backend/schemas/account_schemas.py
  - apps/orchestrator_3_stream/backend/routers/accounts.py
  - apps/orchestrator_3_stream/backend/main.py
autonomous: true

must_haves:
  truths:
    - "Backend can create a user_account for a user"
    - "Backend can list user_accounts for authenticated user"
    - "Backend can get-or-create user_account on first credential add"
  artifacts:
    - path: "apps/orchestrator_3_stream/backend/schemas/account_schemas.py"
      provides: "Pydantic schemas for user account CRUD"
      exports: ["UserAccountResponse", "ListAccountsResponse", "CreateAccountRequest"]
    - path: "apps/orchestrator_3_stream/backend/routers/accounts.py"
      provides: "FastAPI router for user_accounts endpoints"
      exports: ["router"]
    - path: "apps/orchestrator_3_stream/backend/main.py"
      provides: "Includes accounts router"
      contains: "accounts.router"
  key_links:
    - from: "apps/orchestrator_3_stream/backend/routers/accounts.py"
      to: "modules/user_models.py"
      via: "UserAccountORM import"
      pattern: "from modules\\.user_models import.*UserAccountORM"
---

<objective>
Create backend API endpoints for user_accounts management.

Purpose: Frontend needs to know which user_account_id to associate credentials with. Currently credentials router requires account_id but there's no way to list or create user_accounts from frontend.

Output:
- account_schemas.py with Pydantic models
- accounts.py router with GET /api/accounts, POST /api/accounts/get-or-create
- main.py updated to include accounts router
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/orchestrator_3_stream/backend/modules/user_models.py
@apps/orchestrator_3_stream/backend/routers/credentials.py
@apps/orchestrator_3_stream/backend/schemas/credential_schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account Pydantic schemas</name>
  <files>apps/orchestrator_3_stream/backend/schemas/account_schemas.py</files>
  <action>
Create Pydantic schemas for user account management:

1. UserAccountResponse - Response model for account metadata
   - id: str (UUID)
   - user_id: str
   - account_name: str
   - is_active: bool
   - created_at: str (ISO 8601)
   - updated_at: str (ISO 8601)
   - Use ConfigDict(from_attributes=True) for ORM compatibility

2. ListAccountsResponse - Response for listing accounts
   - status: str
   - accounts: List[UserAccountResponse]
   - count: int

3. CreateAccountRequest - Request to create new account
   - account_name: str = Field(..., description="Display name for the account")

4. GetOrCreateAccountResponse - Response from get-or-create
   - account: UserAccountResponse
   - created: bool (True if newly created, False if existing)

Follow the same docstring pattern as credential_schemas.py with security notes and examples.
  </action>
  <verify>uv run python -c "from schemas.account_schemas import UserAccountResponse, ListAccountsResponse, CreateAccountRequest, GetOrCreateAccountResponse; print('Schemas imported successfully')" in backend directory</verify>
  <done>account_schemas.py exists with all 4 Pydantic models and proper validation</done>
</task>

<task type="auto">
  <name>Task 2: Create accounts router with endpoints</name>
  <files>apps/orchestrator_3_stream/backend/routers/accounts.py</files>
  <action>
Create FastAPI router for user_accounts with 3 endpoints:

1. GET /api/accounts - List user's accounts
   - Requires get_current_user dependency
   - Uses get_connection_with_rls for RLS-filtered query
   - Returns ListAccountsResponse with all user's accounts

2. POST /api/accounts - Create new account
   - Requires get_current_user dependency
   - Accepts CreateAccountRequest body
   - Creates new UserAccountORM with user_id from auth
   - Returns UserAccountResponse (201 Created)
   - Handle IntegrityError for duplicate user_id (409 Conflict)

3. POST /api/accounts/get-or-create - Get existing or create default
   - Requires get_current_user dependency
   - Queries for user's account, creates "Default Alpaca Account" if none exists
   - Returns GetOrCreateAccountResponse with account and created flag
   - This endpoint is idempotent - safe to call multiple times

Follow the same pattern as credentials.py:
- Use from modules.auth_middleware import get_current_user, AuthUser
- Use from modules.database import get_connection_with_rls
- Use from modules.user_models import UserAccountORM
- Use from modules.logger import get_logger
- Proper error handling with HTTPException
- Log operations without exposing sensitive data
  </action>
  <verify>uv run python -c "from routers.accounts import router; print(f'Router prefix: {router.prefix}, routes: {len(router.routes)}')" in backend directory</verify>
  <done>accounts.py exists with 3 endpoints (GET list, POST create, POST get-or-create) all using RLS and auth</done>
</task>

<task type="auto">
  <name>Task 3: Include accounts router in main.py</name>
  <files>apps/orchestrator_3_stream/backend/main.py</files>
  <action>
Add accounts router to main.py:

1. Add import: from routers.accounts import router as accounts_router
2. Add router include: app.include_router(accounts_router)
3. Place it near the credentials router include for organizational consistency

Ensure the import is at the top with other router imports and the include is with other router includes.
  </action>
  <verify>Start backend with ./start_be.sh, check http://localhost:9403/docs shows /api/accounts endpoints (GET and two POSTs)</verify>
  <done>main.py includes accounts router, /api/accounts/* endpoints visible in OpenAPI docs</done>
</task>

</tasks>

<verification>
1. Backend starts without errors
2. OpenAPI docs show /api/accounts (GET), /api/accounts (POST), /api/accounts/get-or-create (POST)
3. All endpoints require authentication (return 401 without auth)
4. GET /api/accounts returns empty list for new user
5. POST /api/accounts/get-or-create creates account and returns it
6. Subsequent GET /api/accounts returns the created account
</verification>

<success_criteria>
- account_schemas.py has all 4 Pydantic models
- accounts.py router has 3 endpoints with auth and RLS
- main.py includes accounts router
- All endpoints work with authentication
</success_criteria>

<output>
After completion, create `.planning/phases/04-account-management-ui/04-01-SUMMARY.md`
</output>
