---
phase: 06-trading-context
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue
  - apps/orchestrator_3_stream/frontend/src/services/positionsService.ts
autonomous: true

must_haves:
  truths:
    - "Chat sends credential_id from activeCredentialId in request body"
    - "Chat disabled when no credential selected"
    - "Positions requests include credential_id query parameter"
    - "Stale credential in localStorage is cleared when request returns 403"
  artifacts:
    - path: "apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue"
      provides: "Chat component with credential context"
      contains: "credential_id.*activeCredentialId"
    - path: "apps/orchestrator_3_stream/frontend/src/services/positionsService.ts"
      provides: "Positions service with credential_id parameter"
      contains: "credential_id"
  key_links:
    - from: "AlpacaAgentChat.vue"
      to: "accountStore.activeCredentialId"
      via: "request body injection"
      pattern: "credential_id.*accountStore"
    - from: "positionsService.ts"
      to: "api/positions"
      via: "query parameter"
      pattern: "credential_id"
---

<objective>
Wire frontend to pass credential context to chat and positions endpoints.

Purpose: Complete the credential context chain by having frontend pass activeCredentialId to all trading-related API calls.
Output: Chat and positions requests include credential_id, chat is disabled without credential, stale credentials are handled.
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-trading-context/06-RESEARCH.md

# Key existing files
@apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue
@apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify AlpacaAgentChat to pass credential_id</name>
  <files>apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue</files>
  <action>
Modify the AlpacaAgentChat component to:
1. Import and use accountStore
2. Pass credential_id in chat requests
3. Disable send when no credential selected
4. Handle 403 errors by clearing stale credential

Changes needed:

1. Add import for accountStore in the script setup section:
```typescript
import { useAccountStore } from '@/stores/accountStore'
```

2. Initialize accountStore in the script setup:
```typescript
const accountStore = useAccountStore()
```

3. Modify the sendMessage function to include credential_id and guard against missing credential:

Find the sendMessage function and modify it:

```typescript
async function sendMessage() {
  const content = userInput.value.trim()
  if (!content || isLoading.value) return

  // Guard: Require active credential for chat
  if (!accountStore.activeCredentialId) {
    connectionStatus.value = 'error'
    // Add error message to chat
    const errorMessage: ChatMessage = {
      id: crypto.randomUUID(),
      role: 'assistant',
      content: 'Please select a trading account before sending messages. Use the account selector in the header.',
      timestamp: new Date()
    }
    messages.value.push(errorMessage)
    return
  }

  // ... existing code to add user message ...

  try {
    // ... existing setup code ...

    // Call the backend API with credential_id
    const response = await fetch(`${API_BASE_URL}/api/alpaca-agent/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: content,
        credential_id: accountStore.activeCredentialId  // ADD THIS
      })
    })

    if (!response.ok) {
      // Handle 403 specifically - may indicate stale credential
      if (response.status === 403) {
        // Clear stale credential from store and localStorage
        accountStore.activeCredentialId = null
        try {
          localStorage.removeItem('activeCredentialId')
        } catch (e) {
          console.warn('Failed to clear localStorage:', e)
        }
        throw new Error('Credential no longer valid. Please select a trading account.')
      }

      // ... rest of existing error handling ...
    }

    // ... rest of existing streaming handling ...
  } catch (error) {
    // ... existing catch block ...
  }
}
```

4. Update the send button to be disabled when no credential selected:

In the template, find the send button and update its :disabled condition:
```html
<button
  class="send-btn"
  @click="sendMessage"
  :disabled="!userInput.trim() || isLoading || !accountStore.activeCredentialId"
  title="Send message (Enter)"
>
```

5. Add a visual indicator when no credential is selected. Add this in the input area:
```html
<div v-if="!accountStore.activeCredentialId" class="no-credential-warning">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  </svg>
  <span>Select a trading account to start chatting</span>
</div>
```

6. Add CSS for the warning:
```css
.no-credential-warning {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: 10px 16px;
  background: rgba(234, 179, 8, 0.1);
  border: 1px solid rgba(234, 179, 8, 0.3);
  border-radius: 8px;
  color: rgb(234, 179, 8);
  font-size: 0.8125rem;
  margin-bottom: var(--spacing-sm);
}

.no-credential-warning svg {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}
```
  </action>
  <verify>
Check credential_id in request:
`grep -q "credential_id.*activeCredentialId" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue && echo "credential_id passed in request"`

Check accountStore import:
`grep -q "useAccountStore" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue && echo "accountStore imported"`

Check 403 handling:
`grep -q "response.status === 403" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue && echo "403 handling present"`
  </verify>
  <done>Chat component passes credential_id from accountStore, disables send without credential, handles 403 by clearing stale credential</done>
</task>

<task type="auto">
  <name>Task 2: Create or update positionsService to include credential_id</name>
  <files>apps/orchestrator_3_stream/frontend/src/services/positionsService.ts</files>
  <action>
Check if a positionsService exists. If not, create it. If it exists, modify it to include credential_id.

First, check what services exist:
```bash
ls -la apps/orchestrator_3_stream/frontend/src/services/
```

If positionsService.ts doesn't exist, create it:

```typescript
/**
 * Positions Service
 *
 * Service for fetching trading positions from the backend.
 * All requests include credential_id for account context.
 */

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://127.0.0.1:9403'

export interface Position {
  id: string
  symbol: string
  qty: string
  avg_entry_price: string
  market_value: string
  unrealized_pl: string
  unrealized_plpc: string
  current_price: string
  side: string
}

export interface PositionsResponse {
  status: 'success' | 'error'
  positions?: Position[]
  total_count?: number
  message?: string
}

/**
 * Fetch all positions for the given credential.
 *
 * @param credentialId - UUID of the credential to fetch positions for
 * @returns PositionsResponse with positions or error
 * @throws Error if credential_id is not provided
 */
export async function fetchPositions(credentialId: string): Promise<PositionsResponse> {
  if (!credentialId) {
    throw new Error('credential_id is required to fetch positions')
  }

  const url = new URL(`${API_BASE_URL}/api/positions`)
  url.searchParams.set('credential_id', credentialId)

  const response = await fetch(url.toString(), {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })

  if (!response.ok) {
    if (response.status === 403) {
      throw new Error('Credential access denied')
    }
    const errorData = await response.json().catch(() => ({}))
    throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`)
  }

  return response.json()
}

/**
 * Fetch orders for the given credential.
 *
 * @param credentialId - UUID of the credential to fetch orders for
 * @param status - Order status filter ('all', 'open', 'closed')
 * @param limit - Maximum number of orders to return
 * @returns Order list
 */
export async function fetchOrders(
  credentialId: string,
  status: 'all' | 'open' | 'closed' = 'all',
  limit: number = 100
): Promise<any[]> {
  if (!credentialId) {
    throw new Error('credential_id is required to fetch orders')
  }

  const url = new URL(`${API_BASE_URL}/api/orders`)
  url.searchParams.set('credential_id', credentialId)
  url.searchParams.set('status', status)
  url.searchParams.set('limit', limit.toString())

  const response = await fetch(url.toString(), {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })

  if (!response.ok) {
    if (response.status === 403) {
      throw new Error('Credential access denied')
    }
    const errorData = await response.json().catch(() => ({}))
    throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`)
  }

  const data = await response.json()
  return data.orders || []
}

export default {
  fetchPositions,
  fetchOrders
}
```

If positionsService.ts already exists, modify the existing fetch functions to:
1. Accept credentialId as a required parameter
2. Add credential_id to the query string
3. Handle 403 errors appropriately
  </action>
  <verify>
Check service file exists and has credential_id:
`test -f /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/services/positionsService.ts && echo "File exists"`
`grep -q "credential_id" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/services/positionsService.ts && echo "credential_id in service"`
  </verify>
  <done>positionsService includes credential_id in all position and order requests</done>
</task>

<task type="auto">
  <name>Task 3: Update any positions display components to use credential context</name>
  <files>apps/orchestrator_3_stream/frontend/src/components/PositionsView.vue</files>
  <action>
Check if there's a positions display component that needs updating.

First, find position-related components:
```bash
find apps/orchestrator_3_stream/frontend/src -name "*[Pp]osition*" -o -name "*[Pp]ositions*"
```

If a PositionsView.vue or similar component exists:

1. Import accountStore:
```typescript
import { useAccountStore } from '@/stores/accountStore'
```

2. Import the updated positionsService:
```typescript
import { fetchPositions } from '@/services/positionsService'
```

3. Modify the position fetching logic to use activeCredentialId:
```typescript
const accountStore = useAccountStore()

async function loadPositions() {
  if (!accountStore.activeCredentialId) {
    console.warn('No credential selected, cannot load positions')
    return
  }

  try {
    const response = await fetchPositions(accountStore.activeCredentialId)
    if (response.status === 'success') {
      positions.value = response.positions || []
    } else {
      error.value = response.message || 'Failed to load positions'
    }
  } catch (e) {
    error.value = e instanceof Error ? e.message : 'Failed to load positions'
  }
}
```

4. Add a watcher to reload positions when credential changes:
```typescript
watch(() => accountStore.activeCredentialId, (newId) => {
  if (newId) {
    loadPositions()
  } else {
    positions.value = []
  }
}, { immediate: true })
```

5. Show a message when no credential is selected:
```html
<div v-if="!accountStore.activeCredentialId" class="no-credential-message">
  Select a trading account to view positions
</div>
```

If no positions component exists, note that in the summary - the service is ready for when the component is created.
  </action>
  <verify>
Check if positions component uses accountStore:
`grep -l "activeCredentialId" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/components/*[Pp]osition* 2>/dev/null || echo "No positions component found or doesn't use activeCredentialId yet"`

Or verify the service is importable:
`cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend && npm run build 2>&1 | head -20 || echo "Build check (may show warnings)"`
  </verify>
  <done>Positions display (if exists) uses credential context from accountStore, or service is ready for future component</done>
</task>

</tasks>

<verification>
Overall plan verification:
1. `grep "credential_id.*activeCredentialId" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/components/AlpacaAgentChat.vue` - Chat passes credential
2. `grep "credential_id" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend/src/services/positionsService.ts` - Service uses credential
3. Frontend build succeeds: `cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend && npm run build`
</verification>

<success_criteria>
- Chat component imports and uses accountStore
- Chat sends credential_id from activeCredentialId in request body
- Send button disabled when no credential selected
- Chat handles 403 by clearing stale credential from localStorage
- positionsService includes credential_id in position/order requests
- Visual indicator shown when no credential selected
</success_criteria>

<output>
After completion, create `.planning/phases/06-trading-context/06-03-SUMMARY.md`
</output>
