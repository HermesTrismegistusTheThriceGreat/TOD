---
phase: 05-account-display
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/orchestrator_3_stream/frontend/src/types/account.ts
  - apps/orchestrator_3_stream/frontend/src/services/credentialService.ts
  - apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts
autonomous: true

must_haves:
  truths:
    - "credentialService has getAccountData method"
    - "accountStore has accountData state and fetchAccountData action"
    - "Active credential change triggers account data fetch"
  artifacts:
    - path: "apps/orchestrator_3_stream/frontend/src/types/account.ts"
      provides: "AccountDataResponse TypeScript interface"
      contains: "AccountDataResponse"
    - path: "apps/orchestrator_3_stream/frontend/src/services/credentialService.ts"
      provides: "getAccountData method"
      contains: "getAccountData"
    - path: "apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts"
      provides: "accountData state and fetchAccountData action"
      contains: "accountData"
  key_links:
    - from: "stores/accountStore.ts"
      to: "services/credentialService.ts"
      via: "getAccountData call in fetchAccountData"
      pattern: "credentialService.getAccountData"
    - from: "stores/accountStore.ts"
      to: "setActiveCredential"
      via: "fetchAccountData called when credential changes"
      pattern: "fetchAccountData.*activeCredentialId"
---

<objective>
Extend frontend service layer with account data fetching and state management.

Purpose: UI components need access to account metrics (balance, equity, buying power) via reactive state. This plan adds the service method and store state to fetch and cache account data.

Output: AccountDataResponse type, credentialService.getAccountData() method, accountStore with accountData state, accountDataLoading state, and fetchAccountData action that auto-triggers on credential change.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-account-display/05-RESEARCH.md
@.planning/phases/05-account-display/05-01-SUMMARY.md
@apps/orchestrator_3_stream/frontend/src/types/account.ts
@apps/orchestrator_3_stream/frontend/src/services/credentialService.ts
@apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AccountDataResponse TypeScript interface</name>
  <files>apps/orchestrator_3_stream/frontend/src/types/account.ts</files>
  <action>
Add AccountDataResponse interface to the existing account.ts file (after GetOrCreateAccountResponse):

```typescript
/**
 * Real-time account data response from Alpaca API.
 * Mirrors backend AccountDataResponse schema.
 */
export interface AccountDataResponse {
  /** Account type: "paper" or "live" */
  account_type: string
  /** Cash balance as string (e.g., "100000.25") */
  balance: string
  /** Total equity (cash + positions) as string */
  equity: string
  /** Available buying power as string */
  buying_power: string
  /** Account currency (default: USD) */
  currency: string
  /** Whether trading is blocked */
  trading_blocked: boolean
  /** Whether account activity is prohibited */
  account_blocked: boolean
  /** Whether flagged as pattern day trader */
  pattern_day_trader: boolean
  /** Day trades in last 5 trading days */
  daytrade_count: number
  /** ISO 8601 timestamp of last update */
  last_updated: string
}
```

Use snake_case field names to match backend Pydantic schema (consistent with existing types in this file).
  </action>
  <verify>
Run: `cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend && npm run build 2>&1 | head -20` and check for no TypeScript errors
  </verify>
  <done>AccountDataResponse interface exported from account.ts without TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Add getAccountData method to credentialService</name>
  <files>apps/orchestrator_3_stream/frontend/src/services/credentialService.ts</files>
  <action>
1. Add AccountDataResponse to the import statement:
```typescript
import type {
  // ... existing imports ...
  AccountDataResponse
} from '@/types/account'
```

2. Add getAccountData method to credentialService object (after validateCredential):
```typescript
  /**
   * Fetch real-time account data for a credential.
   * Returns balance, equity, buying power, and account type from Alpaca API.
   *
   * @param credentialId - UUID of the credential
   * @returns Account data response with metrics
   */
  async getAccountData(credentialId: string): Promise<AccountDataResponse> {
    const response = await apiClient.get<AccountDataResponse>(
      `/api/credentials/${credentialId}/account-data`
    )
    return response.data
  }
```

Follow existing patterns in the file (async/await, returns response.data, no try-catch - axios interceptors handle errors).
  </action>
  <verify>
Run: `cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend && npm run build 2>&1 | head -20` and check for no TypeScript errors
  </verify>
  <done>credentialService.getAccountData method exists and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 3: Extend accountStore with accountData state and fetchAccountData action</name>
  <files>apps/orchestrator_3_stream/frontend/src/stores/accountStore.ts</files>
  <action>
1. Add AccountDataResponse to the import:
```typescript
import type {
  UserAccountResponse,
  CredentialResponse,
  CredentialInput,
  CredentialUpdate,
  AccountDataResponse
} from '@/types/account'
```

2. Add new state variables after `isInitialized`:
```typescript
  /** Real-time account data from Alpaca */
  const accountData = ref<AccountDataResponse | null>(null)

  /** Loading state for account data fetch */
  const accountDataLoading = ref<boolean>(false)
```

3. Add new getter after `alpacaCredentials`:
```typescript
  /** Whether account data is available */
  const hasAccountData = computed(() => accountData.value !== null)
```

4. Add fetchAccountData action (after loadActiveCredential):
```typescript
  /**
   * Fetch account data for a credential.
   * Called automatically when active credential changes.
   *
   * @param credentialId - Credential ID to fetch data for
   */
  async function fetchAccountData(credentialId: string): Promise<void> {
    try {
      accountDataLoading.value = true
      // Clear old data while loading
      accountData.value = null

      console.log('[AccountStore] Fetching account data for credential:', credentialId)
      accountData.value = await credentialService.getAccountData(credentialId)
      console.log('[AccountStore] Account data loaded:', accountData.value.account_type)
    } catch (err) {
      console.error('[AccountStore] Failed to fetch account data:', err)
      accountData.value = null
      // Don't throw - account data is supplementary, not critical
    } finally {
      accountDataLoading.value = false
    }
  }

  /**
   * Clear account data.
   * Called when credential is deleted or deselected.
   */
  function clearAccountData(): void {
    accountData.value = null
    accountDataLoading.value = false
  }
```

5. Modify setActiveCredential to trigger fetchAccountData:
```typescript
  function setActiveCredential(credentialId: string): void {
    console.log('[AccountStore] Setting active credential:', credentialId)
    activeCredentialId.value = credentialId

    // Persist to localStorage
    try {
      localStorage.setItem('activeCredentialId', credentialId)
    } catch (err) {
      console.warn('[AccountStore] Failed to save activeCredentialId to localStorage:', err)
    }

    // Fetch account data for new credential
    fetchAccountData(credentialId)
  }
```

6. Modify removeCredential to clear account data if deleted credential was active:
In the existing removeCredential function, after clearing activeCredentialId, add:
```typescript
        // Also clear account data
        clearAccountData()
```

7. Update reset function to clear accountData:
```typescript
  function reset(): void {
    console.log('[AccountStore] Resetting state')
    userAccount.value = null
    credentials.value = []
    activeCredentialId.value = null
    accountData.value = null  // ADD THIS
    accountDataLoading.value = false  // ADD THIS
    error.value = null
    isInitialized.value = false
    // ... rest of reset
  }
```

8. Export new state and actions in return statement:
```typescript
  return {
    // State
    userAccount,
    credentials,
    activeCredentialId,
    isLoading,
    error,
    isInitialized,
    accountData,         // ADD
    accountDataLoading,  // ADD

    // Getters
    activeCredential,
    hasCredentials,
    alpacaCredentials,
    hasAccountData,      // ADD

    // Actions
    initialize,
    reset,
    fetchCredentials,
    addCredential,
    updateCredential,
    removeCredential,
    setActiveCredential,
    loadActiveCredential,
    fetchAccountData,    // ADD
    clearAccountData     // ADD
  }
```
  </action>
  <verify>
Run: `cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend && npm run build 2>&1 | head -30` and check for no TypeScript errors. Also verify: `grep -n "accountData\|fetchAccountData\|clearAccountData" src/stores/accountStore.ts | head -20`
  </verify>
  <done>accountStore has accountData state, accountDataLoading, hasAccountData getter, fetchAccountData and clearAccountData actions, and setActiveCredential triggers fetchAccountData</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/frontend && npm run build`

2. Types exported correctly: `grep "export interface AccountDataResponse" src/types/account.ts`

3. Service method exists: `grep "getAccountData" src/services/credentialService.ts`

4. Store has new state: `grep -E "accountData|accountDataLoading|fetchAccountData" src/stores/accountStore.ts | wc -l` should be > 5
</verification>

<success_criteria>
- AccountDataResponse interface in account.ts matches backend schema
- credentialService.getAccountData() method calls /api/credentials/{id}/account-data
- accountStore has accountData (ref) and accountDataLoading (ref) state
- accountStore has hasAccountData computed getter
- accountStore has fetchAccountData and clearAccountData actions
- setActiveCredential triggers fetchAccountData
- removeCredential clears accountData when deleting active credential
- reset() clears accountData
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-account-display/05-02-SUMMARY.md`
</output>
