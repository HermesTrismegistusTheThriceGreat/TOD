---
phase: 01-security-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/orchestrator_3_stream/backend/modules/encryption_service.py
  - apps/orchestrator_3_stream/backend/modules/config.py
  - apps/orchestrator_3_stream/.env.sample
autonomous: true

must_haves:
  truths:
    - "Encryption key loads from ENCRYPTION_KEY environment variable on server start"
    - "encrypt(plaintext) returns base64-encoded ciphertext different from input"
    - "decrypt(ciphertext) returns original plaintext exactly"
    - "Missing ENCRYPTION_KEY raises clear error with generation instructions"
  artifacts:
    - path: "apps/orchestrator_3_stream/backend/modules/encryption_service.py"
      provides: "CredentialEncryptionService class with encrypt/decrypt methods"
      exports: ["CredentialEncryptionService", "get_encryption_service"]
      min_lines: 50
    - path: "apps/orchestrator_3_stream/backend/modules/config.py"
      provides: "ENCRYPTION_KEY loading from environment"
      contains: "ENCRYPTION_KEY"
    - path: "apps/orchestrator_3_stream/.env.sample"
      provides: "ENCRYPTION_KEY placeholder for developers"
      contains: "ENCRYPTION_KEY="
  key_links:
    - from: "apps/orchestrator_3_stream/backend/modules/encryption_service.py"
      to: "os.getenv"
      via: "ENCRYPTION_KEY environment variable"
      pattern: 'os\\.getenv.*ENCRYPTION_KEY'
    - from: "apps/orchestrator_3_stream/backend/modules/encryption_service.py"
      to: "cryptography.fernet.Fernet"
      via: "encryption cipher"
      pattern: "Fernet\\("
---

<objective>
Create the core credential encryption service using Fernet symmetric encryption.

Purpose: This service is the foundation for all credential storage in subsequent phases. Without working encryption, no user API credentials can be safely stored.

Output: A working CredentialEncryptionService class that encrypts and decrypts credentials, plus environment configuration for the encryption key.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-security-foundation/01-RESEARCH.md

# Existing files to modify
@apps/orchestrator_3_stream/backend/modules/config.py
@apps/orchestrator_3_stream/.env.sample
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CredentialEncryptionService</name>
  <files>apps/orchestrator_3_stream/backend/modules/encryption_service.py</files>
  <action>
Create a new file `encryption_service.py` in the modules directory with:

1. **CredentialEncryptionService class** with:
   - `__init__`: Load ENCRYPTION_KEY from environment, raise ValueError with helpful message if missing (include key generation command)
   - `encrypt(plaintext: str) -> str`: Encrypt string to base64-encoded ciphertext. Handle empty strings (return empty). Raise ValueError for None input.
   - `decrypt(ciphertext: str) -> str`: Decrypt base64 ciphertext back to plaintext. Handle empty strings. Raise InvalidToken on corruption.

2. **Singleton pattern** via `get_encryption_service()` function that lazily initializes the service (avoid creating service at import time since env vars may not be loaded yet).

3. **Proper encoding**:
   - Use UTF-8 for plaintext encoding before encryption
   - Use ASCII for ciphertext encoding (Fernet output is ASCII-safe base64)

4. **Logging**:
   - Import logger from modules.logger
   - Log errors on encryption/decryption failures (but NEVER log credential values)
   - Do NOT log success cases (would be too verbose)

Use the cryptography library's Fernet class. Reference the code example in 01-RESEARCH.md for the implementation pattern.

DO NOT:
- Log any credential values (plaintext or ciphertext)
- Cache decrypted credentials
- Hardcode any keys
  </action>
  <verify>
```bash
cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/backend
# Check file exists and has expected exports
python -c "from modules.encryption_service import CredentialEncryptionService, get_encryption_service; print('Imports OK')"
```
  </verify>
  <done>
- encryption_service.py exists with CredentialEncryptionService class
- Class has encrypt() and decrypt() methods
- get_encryption_service() function provides singleton access
- ValueError raised when ENCRYPTION_KEY is missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Update config.py with ENCRYPTION_KEY</name>
  <files>apps/orchestrator_3_stream/backend/modules/config.py</files>
  <action>
Add ENCRYPTION_KEY configuration to config.py:

1. **After the DATABASE configuration section**, add a new section:
```python
# ============================================================================
# ENCRYPTION CONFIGURATION
# ============================================================================

# Encryption key for credential storage (Fernet)
# Generate with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
ENCRYPTION_KEY = os.getenv("ENCRYPTION_KEY", "")

# Validate encryption key is set (required for credential storage)
if not ENCRYPTION_KEY:
    config_logger.warning(
        "ENCRYPTION_KEY not set - credential encryption disabled. "
        "Generate with: python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\""
    )
```

2. **Add to startup logging section** (in the config logger output block):
```python
config_logger.info(f"Encryption Key:  {'configured' if ENCRYPTION_KEY else 'NOT SET (required for credentials)'}")
```

DO NOT:
- Log the actual encryption key value
- Make the key required at startup (Phase 1 establishes infrastructure; Phase 2+ will require it)
  </action>
  <verify>
```bash
cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/backend
python -c "from modules.config import ENCRYPTION_KEY; print(f'ENCRYPTION_KEY loaded: {bool(ENCRYPTION_KEY)}')"
```
  </verify>
  <done>
- config.py has ENCRYPTION_KEY variable loaded from environment
- Warning logged if ENCRYPTION_KEY is not set
- Key generation command documented in config.py comment
- Encryption key status shown in startup logs (configured/not set, never the actual value)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update .env.sample with ENCRYPTION_KEY</name>
  <files>apps/orchestrator_3_stream/.env.sample</files>
  <action>
Add ENCRYPTION_KEY placeholder to .env.sample:

1. **Add new section after Database Configuration**:
```
# Encryption Configuration
# Generate key with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
# IMPORTANT: Keep this key secret and never commit it to version control
ENCRYPTION_KEY=
```

2. **Add comment** explaining this is required for credential storage in future phases.

The .env.sample file serves as documentation for developers setting up the project.
  </action>
  <verify>
```bash
grep -q "ENCRYPTION_KEY" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/.env.sample && echo "ENCRYPTION_KEY found in .env.sample"
```
  </verify>
  <done>
- .env.sample contains ENCRYPTION_KEY placeholder
- Key generation command documented
- Security warning about not committing key to version control
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Import check**:
```bash
cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/backend
python -c "
from modules.encryption_service import CredentialEncryptionService, get_encryption_service
from modules.config import ENCRYPTION_KEY
print('All imports successful')
"
```

2. **Quick encrypt/decrypt test** (requires ENCRYPTION_KEY set):
```bash
cd /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/backend
ENCRYPTION_KEY=$(python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())") \
python -c "
import os
os.environ['ENCRYPTION_KEY'] = os.environ.get('ENCRYPTION_KEY', '')
from modules.encryption_service import get_encryption_service
svc = get_encryption_service()
original = 'test-api-key-123'
encrypted = svc.encrypt(original)
decrypted = svc.decrypt(encrypted)
assert decrypted == original, f'Round-trip failed: {original} != {decrypted}'
assert encrypted != original, 'Encryption should change the value'
print('Encryption round-trip: PASSED')
"
```

3. **File structure check**:
```bash
ls -la /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/backend/modules/encryption_service.py
grep "ENCRYPTION_KEY" /Users/muzz/Desktop/tac/TOD/apps/orchestrator_3_stream/.env.sample
```
</verification>

<success_criteria>
- [ ] encryption_service.py exists with CredentialEncryptionService class
- [ ] encrypt/decrypt methods work correctly (round-trip test passes)
- [ ] ENCRYPTION_KEY loads from environment variable
- [ ] Missing ENCRYPTION_KEY raises helpful error with generation command
- [ ] config.py logs encryption key status (configured/not set) without revealing key
- [ ] .env.sample documents ENCRYPTION_KEY with generation instructions
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-01-SUMMARY.md`
</output>
