---
phase: 03-credential-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/orchestrator_3_stream/backend/routers/credentials.py
  - apps/orchestrator_3_stream/backend/modules/database.py
  - apps/orchestrator_3_stream/backend/main.py
autonomous: true

must_haves:
  truths:
    - "POST /api/credentials/store accepts plaintext credentials and stores encrypted"
    - "GET /api/credentials returns credential metadata without plaintext values"
    - "POST /api/credentials/{id}/validate decrypts and validates against Alpaca API"
    - "PUT /api/credentials/{id} allows updating existing credentials"
    - "RLS context is set via middleware before database queries"
  artifacts:
    - path: "apps/orchestrator_3_stream/backend/routers/credentials.py"
      provides: "FastAPI router with credential CRUD endpoints"
      exports: ["router"]
    - path: "apps/orchestrator_3_stream/backend/modules/database.py"
      provides: "RLS context setter and credential queries"
      contains: "set_rls_context"
  key_links:
    - from: "routers/credentials.py"
      to: "modules/credential_service.py"
      via: "imports credential functions"
      pattern: "from modules.credential_service import"
    - from: "routers/credentials.py"
      to: "modules/auth_middleware.py"
      via: "uses get_current_user dependency"
      pattern: "Depends\\(get_current_user\\)"
    - from: "main.py"
      to: "routers/credentials.py"
      via: "includes router"
      pattern: "app.include_router"
---

<objective>
Create FastAPI credential API endpoints with RLS middleware integration.

Purpose: Expose secure REST endpoints for credential CRUD operations with row-level security enforcement.
Output: credentials.py router with all endpoints, database.py with RLS context, main.py includes router.
</objective>

<execution_context>
@/Users/muzz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/muzz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-credential-management/03-RESEARCH.md
@.planning/phases/03-credential-management/03-01-SUMMARY.md
@apps/orchestrator_3_stream/backend/modules/auth_middleware.py
@apps/orchestrator_3_stream/backend/modules/database.py
@apps/orchestrator_3_stream/backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RLS context helper to database.py</name>
  <files>apps/orchestrator_3_stream/backend/modules/database.py</files>
  <action>
Add RLS context management function to existing database.py:

1. **set_rls_context** async function:
   - Parameters: conn (asyncpg connection), user_id (str)
   - Executes: `SET LOCAL app.current_user_id = '{user_id}'`
   - Uses SET LOCAL so context is transaction-scoped
   - This matches the RLS policy from Phase 2 migration 15

2. **get_connection_with_rls** async context manager:
   - Parameters: user_id (str)
   - Acquires connection from pool
   - Calls set_rls_context before yielding
   - Yields connection
   - This is a convenience wrapper for RLS-aware queries

Add to the CREDENTIAL OPERATIONS section (create new section if needed).

Do NOT modify existing functions - only add new ones.
  </action>
  <verify>
```bash
cd apps/orchestrator_3_stream/backend && uv run python -c "
from modules.database import set_rls_context, get_connection_with_rls
import inspect

# Verify set_rls_context is async function
assert inspect.iscoroutinefunction(set_rls_context), 'set_rls_context should be async'

# Verify get_connection_with_rls is async context manager
assert hasattr(get_connection_with_rls, '__call__'), 'get_connection_with_rls should be callable'

print('OK - RLS functions added to database.py')
"
```
  </verify>
  <done>database.py exports set_rls_context and get_connection_with_rls functions</done>
</task>

<task type="auto">
  <name>Task 2: Create FastAPI credentials router</name>
  <files>apps/orchestrator_3_stream/backend/routers/credentials.py</files>
  <action>
Create new directory `routers/` if not exists. Create credentials.py with:

1. **POST /api/credentials/store** - Store new credential:
   - Request: StoreCredentialRequest
   - Response: CredentialResponse (201 Created)
   - Validates user owns the account_id
   - Checks for duplicate (account_id + credential_type)
   - TypeDecorator encrypts automatically on insert
   - Returns 403 if unauthorized, 409 if duplicate

2. **GET /api/credentials** - List credentials:
   - Query param: account_id (required)
   - Response: ListCredentialsResponse
   - RLS filters to user's credentials
   - Returns metadata only (never plaintext)

3. **POST /api/credentials/{credential_id}/validate** - Validate credential:
   - Response: ValidateCredentialResponse
   - Decrypts from DB, calls Alpaca API, returns bool result
   - Returns 403 if user doesn't own credential
   - Returns 400 if credential is inactive

4. **PUT /api/credentials/{credential_id}** - Update credential:
   - Request: UpdateCredentialRequest
   - Response: CredentialResponse
   - Updates api_key, secret_key, or is_active
   - Returns 403 if unauthorized

5. **DELETE /api/credentials/{credential_id}** - Delete credential:
   - Response: 204 No Content
   - Hard delete (or soft delete by setting is_active=False)
   - Returns 403 if unauthorized

All endpoints:
- Use `Depends(get_current_user)` for authentication
- Use `Depends(get_db)` or direct database connection with RLS context
- Log operations but NEVER log credential values
- Use proper HTTP status codes

Router prefix: "/api/credentials"
Tags: ["Credentials"]
  </action>
  <verify>
```bash
cd apps/orchestrator_3_stream/backend && uv run python -c "
from routers.credentials import router
from fastapi import APIRouter

# Verify it's a FastAPI router
assert isinstance(router, APIRouter), 'Should be APIRouter instance'

# Verify routes exist
routes = [r.path for r in router.routes]
assert '/store' in routes or any('/store' in str(r.path) for r in router.routes), 'Should have /store endpoint'
print(f'Routes found: {routes}')
print('OK - Credentials router created')
"
```
  </verify>
  <done>credentials.py router with store, list, validate, update, delete endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Include credentials router in main.py</name>
  <files>apps/orchestrator_3_stream/backend/main.py</files>
  <action>
Modify main.py to include the credentials router:

1. Add import at top with other router imports:
   ```python
   from routers.credentials import router as credentials_router
   ```

2. Include router after app creation (after CORS middleware):
   ```python
   app.include_router(credentials_router)
   ```

This makes all credential endpoints available at /api/credentials/*.

Do NOT modify any existing endpoints or functionality.
  </action>
  <verify>
```bash
cd apps/orchestrator_3_stream/backend && uv run python -c "
from main import app

# Verify credentials routes are registered
routes = [r.path for r in app.routes]
has_credentials = any('/api/credentials' in str(r.path) for r in app.routes)
print(f'Has credentials routes: {has_credentials}')
print(f'Sample routes: {[r.path for r in app.routes if \"credential\" in str(r.path).lower()][:5]}')
assert has_credentials, 'Credentials routes should be registered'
print('OK - Credentials router included in main.py')
"
```
  </verify>
  <done>main.py includes credentials router, /api/credentials/* endpoints are accessible</done>
</task>

</tasks>

<verification>
1. database.py has set_rls_context function
2. routers/credentials.py exports router with all 5 endpoints
3. main.py includes credentials router
4. `uv run python -c "from main import app"` succeeds without import errors
5. No credential values appear in any log statements
</verification>

<success_criteria>
- POST /api/credentials/store accepts StoreCredentialRequest
- GET /api/credentials returns list with metadata only
- POST /api/credentials/{id}/validate returns boolean validation result
- PUT /api/credentials/{id} updates credential fields
- DELETE /api/credentials/{id} returns 204 No Content
- All endpoints require authentication via get_current_user
</success_criteria>

<output>
After completion, create `.planning/phases/03-credential-management/03-02-SUMMARY.md`
</output>
